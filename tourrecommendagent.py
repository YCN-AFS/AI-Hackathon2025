# -*- coding: utf-8 -*-
"""Báº£n sao cá»§a TourRecommendAgent.ipynb

Automatically generated by Colab.

Original file is located at
    https://colab.research.google.com/drive/1ehRQT0UNiTzsWObHRymh8TKWs4LcNf4Q
"""

# Commented out IPython magic to ensure Python compatibility.
# %%capture --no-stderr
# %pip install -U langgraph langchain-community langchain-anthropic tavily-python pandas

!pip install --upgrade --quiet langchain-huggingface text-generation transformers google-search-results numexpr langchainhub sentencepiece jinja2 bitsandbytes accelerate

!pip install -qU langchain-community faiss-cpu

!pip install --quiet langchain_experimental

!pip install -qU langchain-google-genai

import os
# import shutil
# import sqlite3

import pandas as pd
import requests
from langchain_huggingface import ChatHuggingFace, HuggingFaceEndpoint

from typing import Annotated, Literal, Optional
from typing_extensions import TypedDict
from langgraph.graph.message import AnyMessage, add_messages
from pydantic import BaseModel, Field
from typing import List
from langgraph.types import interrupt

import uuid
from typing import TypedDict, Optional

from langgraph.graph import StateGraph
from langgraph.constants import START, END
from langgraph.types import interrupt, Command
from langgraph.checkpoint.memory import MemorySaver
from langchain_core.runnables import Runnable, RunnableConfig, RunnableLambda
from langchain_core.prompts import ChatPromptTemplate
from IPython.display import Image, display
import getpass
import os
from langgraph.prebuilt import ToolNode, tools_condition
from langchain_core.messages import ToolMessage, HumanMessage, SystemMessage
from typing import Callable
import requests
from datetime import datetime, timedelta
from langchain_google_genai import ChatGoogleGenerativeAI
from langchain_community.tools.tavily_search import TavilySearchResults
from langchain_core.tools import tool
import json

"""# Chat Model

- **Remote**
"""

# if "GOOGLE_API_KEY" not in os.environ:
#     os.environ["GOOGLE_API_KEY"] = getpass.getpass("Enter your Google AI API key: ")

os.environ["GOOGLE_API_KEY"] = "AIzaSyBt4n2O89U7XKNM2LDwa0DSP5MI80yEwpA"

# os.environ["GOOGLE_API_KEY"] = "AIzaSyD8Nzvo0C3HNqFQ05KUlnt3VxF2AMe_f6A"

# gemini-1.5-flash, gemini-2.0-flash-thinking-exp

llm = ChatGoogleGenerativeAI(
    model="gemini-1.5-flash",
    temperature=0.5,
    max_tokens=None,
    timeout=None,
    max_retries=2,
    context_window = 4096, # Context Window specifies how many tokens to use as context for the LLM
    max_new_tokens = 4096 # Max New Tokens specifies how many new tokens to generate for the LLM
    # other params...
)

# llm = HuggingFaceEndpoint(
#     repo_id="Qwen/Qwen2.5-72B-Instruct",
#     temperature=0.5,
#     max_tokens=None,
#     timeout=None,
#     max_retries=2,
#     context_window = 4096, # Context Window specifies how many tokens to use as context for the LLM
#     max_new_tokens = 4096 # Max New Tokens specifies how many new tokens to generate for the LLM
#     # other params...
# )

# llm = ChatHuggingFace(llm=llm)

messages = [
    (
        "system",
        "Báº¡n lÃ  trá»£ thá»§ Ä‘áº¯c lá»±c nha."
        "HÃ£y tráº£ lá»i báº±ng tiáº¿ng viá»‡t"
    ),
    ("human", "Xin chÃ o, báº¡n nÃ³i Ä‘Æ°á»£c tiáº¿ng viá»‡t tá»‘t khÃ´ng?"),
]
ai_msg = llm.invoke(messages)
ai_msg

"""# Define State"""

def update_dialog_stack(container: list[str], what: Optional[str]) -> list[str]:
    """Push or pop the state."""
    if what is None:
        return container
    if what == "pop":
        return container[:-1]
    return container + [what]


class Preferences(BaseModel):
    name: Optional[str] = Field("VÃ´ Danh", description="TÃªn ngÆ°á»i dÃ¹ng")
    number_member: Optional[str] = Field("2", description="Tá»•ng sá»‘ thÃ nh viÃªn trong nhÃ³m")
    total_expense: Optional[str] = Field("2 triá»‡u", description="Chi phÃ­ tá»•ng mÃ  ngÆ°á»i dÃ¹ng cÃ³ thá»ƒ bá» ra cho chuyáº¿n Ä‘i")

    # buy_souvenir: Optional[str] = Field("CÃ³", description="CÃ³ muá»‘n mua quÃ  lÆ°u niá»‡m khÃ´ng? (CÃ³ /KhÃ´ng)")
    # allergy: Optional[str] = Field("KhÃ´ng", description="Danh sÃ¡ch cÃ¡c dá»‹ á»©ng (vÃ­ dá»¥: Ä‘áº­u phá»™ng, háº£i sáº£n)")
    # illness: Optional[str] = Field("KhÃ´ng", description="Danh sÃ¡ch bá»‡nh lÃ½ (vÃ­ dá»¥: tiá»ƒu Ä‘Æ°á»ng, cao huyáº¿t Ã¡p)")
    # food: Optional[str] = Field("KhÃ´ng", description="Cháº¿ Ä‘á»™ Äƒn uá»‘ng: Äƒn chay hoáº·c Äƒn máº·n")
    # get_up_time: Optional[str] = Field("7:00", description="Thá»i gian thá»©c dáº­y mong muá»‘n (Ä‘á»‹nh dáº¡ng HH:MM)")
    # number_meal: Optional[str] = Field("3", description="Sá»‘ bá»¯a Äƒn trong má»™t ngÃ y")
    # take_a_nap: Optional[str] = Field("KhÃ´ng", description="CÃ³ ngá»§ trÆ°a khÃ´ng? (CÃ³ /KhÃ´ng)")
    # sleeping_time: Optional[str] = Field("12:00", description="Thá»i gian Ä‘i ngá»§ mong muá»‘n (Ä‘á»‹nh dáº¡ng HH:MM)")
    # start_day: Optional[str] = Field("2 triá»‡u", description="Chi phÃ­ tá»•ng mÃ  ngÆ°á»i dÃ¹ng cÃ³ thá»ƒ bá» ra cho chuyáº¿n Ä‘i")


class State(TypedDict):
    messages: Annotated[list[AnyMessage], add_messages]
    preferences: Preferences
    Recommended_Tour: dict


    # user_info: str

    dialog_state: Annotated[
        list[
            Literal[
                "Primary_Agent",
                "Accommodation_Agent",
                "Destination_Agent",
                "Food_Agent",
                "Transaction_Agent"
            ]
        ],
        update_dialog_stack,
    ]

"""# Primary Agent

## Tool
"""

def asking_preference(state: State):
    print("""
            TrÆ°á»›c tiÃªn, tá»› muá»‘n há»i báº¡n vá» má»™t sá»‘ thá»© Ä‘á»ƒ hiá»ƒu rÃµ hÆ¡n vá» báº¡n. Náº¿u bá» qua hÃ£y nháº¥n enter
          """)

    answer0 = input(
        """
        Báº¡n tÃªn gÃ¬?
        """
    )

    answer1 = input(
        """
        Sá»‘ thÃ nh viÃªn trong nhÃ³m?
        (Máº·c Ä‘á»‹nh lÃ  2)
        """
    ) or "2"


    answer2 = input(
        """
        Tá»•ng chi phÃ­ báº¡n bá» ra cho cáº£ má»™t chuyáº¿n Ä‘i lÃ  bao nhiÃªu?
        (Máº·c Ä‘á»‹nh lÃ  3.000.000)
        """
    ) or "3.000.000"

    # answer3 = input(
    #     """
    #     Trong nhÃ³m cÃ³ ai bá»‹ dá»‹ á»©ng vá» cÃ¡i gÃ¬ khÃ´ng?
    #     VÃ­ dá»¥: háº£i sáº£n, Ä‘áº­u phá»™ng, ...
    #     (Máº·c Ä‘á»‹nh lÃ  KhÃ´ng)
    #     """
    # ) or "KhÃ´ng"

    # answer4 = input(
    #     """
    #     Trong nhÃ³m cÃ³ ai bá»‹ máº¯c bá»‡nh gÃ¬ khÃ´ng?
    #     VÃ­ dá»¥: tim, huyáº¿t Ã¡p cao, ...
    #     (Máº·c Ä‘á»‹nh lÃ  KhÃ´ng)
    #     """
    # ) or "KhÃ´ng"

    # answer5 = input(
    #     """
    #     NhÃ³m mÃ¬nh thÃ­ch Äƒn gÃ¬?
    #     VÃ­ dá»¥: háº£i sáº£n, chay, thá»‹t nÆ°á»›ng, ...
    #     (Máº·c Ä‘á»‹nh lÃ  KhÃ´ng)
    #     """
    # ) or "Máº·n"

    # answer6 = input(
    #     """
    #     NhÃ³m mÃ¬nh thÆ°á»ng thá»©c dáº­y lÃºc máº¥y giá»?
    #     (Máº·c Ä‘á»‹nh lÃ  7:00)
    #     """
    # ) or "7:00"

    # answer7 = input(
    #     """
    #     NhÃ³m mÃ¬nh Äƒn bao nhiÃªu bá»¯a trong ngÃ y?
    #     (Máº·c Ä‘á»‹nh lÃ  3)
    #     """
    # ) or "3"

    # answer8 = input(
    #     """
    #     NhÃ³m mÃ¬nh cÃ³ muá»‘n ngá»§ trÆ°a khÃ´ng?
    #     (Máº·c Ä‘á»‹nh lÃ  KhÃ´ng)
    #     """
    # ) or "KhÃ´ng"

    # answer9 = input(
    #     """
    #     NhÃ³m mÃ¬nh thÆ°á»ng ngá»§ vÃ o máº¥y giá»?
    #     (Máº·c Ä‘á»‹nh lÃ  12:00)
    #     """
    # ) or "12:00"

    # answer10 = input(
    #     """
    #     NhÃ³m mÃ¬nh cÃ³ muá»‘n mua quÃ  lÆ°u niá»‡m khÃ´ng?
    #     (Máº·c Ä‘á»‹nh lÃ  CÃ³)
    #     """
    # ) or "CÃ³"


    return {
        "preferences": Preferences(
            name=answer0,
            number_member=answer1,
            total_expense=answer2,
            # allergy=answer3,
            # illness=answer4,
            # food=answer5,
            # get_up_time=answer6,
            # number_meal=answer7,
            # take_a_nap=answer8,
            # sleeping_time=answer9,
            # buy_souvenir=answer10
        )
    }

class ToAccommodation_Agent(BaseModel):
    """Chuyá»ƒn cuá»™c há»™i thoáº¡i cho Accommodation_Agent, ngÆ°á»i cho chuyÃªn mÃ´n vá» nÆ¡i á»Ÿ (khÃ¡ch sáº¡n, homestay, resort...) á»Ÿ Viá»‡t Nam
     dá»±a trÃªn sá»Ÿ thÃ­ch, ngÃ¢n sÃ¡ch vÃ  nhu cáº§u cá»§a ngÆ°á»i dÃ¹ng."""

    main_location: str = Field(
        ...,
        description="Äá»‹a Ä‘iá»ƒm chÃ­nh mÃ  ngÆ°á»i dÃ¹ng muá»‘n Ä‘áº·t nÆ¡i á»Ÿ",
        example="Nha Trang"
    )
    expense: str = Field(
        ...,
        description="Sá»‘ tiá»n mÃ  ngÆ°á»i dÃ¹ng cÃ³ thá»ƒ bá» ra thuÃª nÆ¡i á»Ÿ",
        example="DÆ°á»›i 200.000 VNÄ"
    )
    option: str = Field(
        ...,
        description="Nhá»¯ng lÆ°u Ã½, mong muá»‘n, yÃªu cáº§u phá»¥ cá»§a ngÆ°á»i dÃ¹ng liÃªn quan Ä‘áº¿n Ä‘á»‹a Ä‘iá»ƒm chÃ­nh cá»§a nÆ¡i á»Ÿ",
        example="Gáº§n biá»ƒn"
    )

class ToDestination_Agent(BaseModel):
    """Chuyá»ƒn cuá»™c há»™i thoáº¡i cho Destination_Agent, ngÆ°á»i cho chuyÃªn mÃ´n vá» Ä‘á»‹a Ä‘iá»ƒm ná»•i tiáº¿ng á»Ÿ Viá»‡t Nam (nhÆ° ÄÃ  Láº¡t, ÄÃ  Náºµng, ...)
    dá»±a trÃªn sá»Ÿ thÃ­ch, ngÃ¢n sÃ¡ch vÃ  nhu cáº§u cá»§a ngÆ°á»i dÃ¹ng."""

    main_location: str = Field(
        ...,
        description="Äá»‹a Ä‘iá»ƒm du lá»‹ch chÃ­nh mÃ  ngÆ°á»i dÃ¹ng muá»‘n Ä‘áº¿n",
        example="SÃ i GÃ²n"
    )
    expense: str = Field(
        ...,
        description="Sá»‘ tiá»n mÃ  ngÆ°á»i dÃ¹ng cÃ³ thá»ƒ bá» ra Ä‘á»ƒ Ä‘áº¿n nÆ¡i Ä‘Ã³",
        example="DÆ°á»›i 2000.000 VNÄ"
    )
    option: str = Field(
        ...,
        description="Nhá»¯ng lÆ°u Ã½, mong muá»‘n, yÃªu cáº§u phá»¥ cá»§a ngÆ°á»i dÃ¹ng liÃªn quan Ä‘áº¿n Ä‘á»‹a Ä‘iá»ƒm du lá»‹ch chÃ­nh",
        example="DÃ nh cho giá»›i tráº»"
    )

class ToFood_Agent(BaseModel):
    """Chuyá»ƒn cuá»™c há»™i thoáº¡i cho Food_Agent, ngÆ°á»i chuyÃªn tÆ° váº¥n vá» cÃ¡c Ä‘á»‹a Ä‘iá»ƒm áº©m thá»±c (nhÆ° nhÃ  hÃ ng, quÃ¡n Äƒn, vá»‰a hÃ¨) á»Ÿ Viá»‡t Nam
    dá»±a trÃªn sá»Ÿ thÃ­ch, ngÃ¢n sÃ¡ch vÃ  nhu cáº§u cá»§a ngÆ°á»i dÃ¹ng."""

    main_location: str = Field(
        ...,
        description="Khu vá»±c hoáº·c Ä‘á»‹a Ä‘iá»ƒm mÃ  ngÆ°á»i dÃ¹ng muá»‘n tÃ¬m kiáº¿m cÃ¡c Ä‘á»‹a Ä‘iá»ƒm Äƒn uá»‘ng",
        example="HÃ  Ná»™i"
    )
    expense: str = Field(
        ...,
        description="Sá»‘ tiá»n mÃ  ngÆ°á»i dÃ¹ng dá»± Ä‘á»‹nh chi cho bá»¯a Äƒn hoáº·c tráº£i nghiá»‡m áº©m thá»±c",
        example="DÆ°á»›i 500.000 VNÄ"
    )
    allergy: str = Field(
        ...,
        description="Danh sÃ¡ch cÃ¡c mÃ³n Äƒn dá»‹ á»©ng",
        example="Äáº­u phá»™ng, háº£i sáº£n"
    )
    option: str = Field(
        ...,
        description="Nhá»¯ng lÆ°u Ã½, mong muá»‘n, yÃªu cáº§u phá»¥ cá»§a ngÆ°á»i dÃ¹ng liÃªn quan Ä‘áº¿n tráº£i nghiá»‡m áº©m thá»±c",
        example="CÃ³ Ä‘á»“ Äƒn chay"
    )

class ToTransaction_Agent(BaseModel):
    """Chuyá»ƒn cuá»™c há»™i thoáº¡i cho Transaction_Agent, ngÆ°á»i chuyÃªn thá»±c hiá»‡n cÃ¡c váº¥n Ä‘á» liÃªn quan Ä‘áº¿n giao dá»‹ch.
    Khi ngÆ°á»i dÃ¹ng yÃªu cáº§u báº¥t cá»© gÃ¬ vá» giao dá»‹ch, pháº£i nhá» sá»± giÃºp Ä‘á»¡ Transaction_Agent.\n
    **KhÃ´ng Ä‘Æ°á»£c tá»± Ã½ tráº£ lá»i**"""

"""## Prompt"""

def format_preferences(preferences: Preferences) -> str:
    return (
        f"- TÃªn ngÆ°á»i dÃ¹ng (Ä‘áº¡i diá»‡n cho nhÃ³m): {preferences.name}\n"
        f"- Sá»‘ thÃ nh viÃªn trong nhÃ³m: {preferences.number_member}\n"
        f"- Tá»•ng sá»‘ tiá»n mÃ  nhÃ³m cÃ³ thá»ƒ bá» ra cho cáº£ má»™t chuyáº¿n Ä‘i: {preferences.total_expense}\n"
        # f"- Dá»‹ á»©ng: {preferences.allergy}\n"
        # f"- Bá»‡nh lÃ½: {preferences.illness}\n"
        # f"- Loáº¡i mÃ³n Äƒn Æ°a thÃ­ch {preferences.food}\n"
        # f"- Thá»i gian thá»©c dáº­y: {preferences.get_up_time}\n"
        # f"- Sá»‘ bá»¯a Äƒn trong 1 ngÃ y: {preferences.number_meal}\n"
        # f"- ThÃ³i quen ngá»§ trÆ°a: {preferences.take_a_nap} ngá»§ trÆ°a\n"
        # f"- Giá» Ä‘i ngá»§: {preferences.sleeping_time}\n"
        # f"- CÃ³ mua quÃ  lÆ°u niá»‡m khÃ´ng? {preferences.buy_souvenir} mua\n"
    )

def create_prompt(preferences: Preferences):
    preferences_text = format_preferences(preferences)

    agent_prompt = ChatPromptTemplate.from_messages(
        [
            (
                "system",
                "Báº¡n lÃ  má»™t trá»£ lÃ½ du lá»‹ch thÃ´ng minh, chuyÃªn giÃºp ngÆ°á»i dÃ¹ng lÃªn lá»‹ch trÃ¬nh vÃ  sáº¯p xáº¿p thá»i gian chuyáº¿n Ä‘i.\n"
                "ğŸ“Œ Chá»©c nÄƒng chÃ­nh cá»§a báº¡n lÃ  Ä‘iá»u phá»‘i cuá»™c há»™i thoáº¡i cho cÃ¡c Agent chuyÃªn mÃ´n khÃ¡c dá»±a trÃªn cÃ¢u há»i cá»§a ngÆ°á»i dÃ¹ng.\n"
                "âŒ Báº¡n khÃ´ng tÆ° váº¥n vá» lá»‹ch trÃ¬nh, nÆ¡i á»Ÿ, phÆ°Æ¡ng tiá»‡n di chuyá»ƒn, Äƒn uá»‘ng hay cÃ¡c hoáº¡t Ä‘á»™ng khÃ¡c.\n\n"

                "ğŸ’¡ **HÆ°á»›ng dáº«n quan trá»ng chung:**\n"
                "- Tráº£ lá»i ngáº¯n gá»n, dá»… hiá»ƒu báº±ng tiáº¿ng Viá»‡t (ngÆ°á»i dÃ¹ng khÃ´ng hiá»ƒu cÃ¡c ngÃ´n ngá»¯ khÃ¡c).\n"
                "- XÆ°ng hÃ´ thÃ¢n thiá»‡n: 'tÃ´i' vá»›i 'báº¡n'.\n"
                "- Náº¿u cÃ³ cÃ´ng cá»¥ phÃ¹ há»£p, hÃ£y sá»­ dá»¥ng cÃ´ng cá»¥ Ä‘Ã³ Ä‘á»ƒ cÃ³ thÃªm thÃ´ng tin phÃ¹ há»£p, trÆ°á»›c khi tráº£ lá»i cÃ¢u há»i cá»§a ngÆ°á»i dÃ¹ng.\n"
                "- Sau khi tráº£ lá»i xong cÃ¢u há»i, hÃ£y há»i: \"TÃ´i cÃ³ thá»ƒ giÃºp gÃ¬ thÃªm cho báº¡n?\"\n"
                "- Náº¿u ngÆ°á»i dÃ¹ng há»i ngoÃ i chuyÃªn mÃ´n vÃ  khÃ´ng cÃ³ Agent nÃ o phÃ¹ há»£p, hÃ£y tráº£ lá»i: \"Xin lá»—i tÃ´i chÆ°a thá»ƒ giÃºp Ä‘á»¡ báº¡n vá» váº¥n Ä‘á» nÃ y.\"\n\n"

                "ğŸ’¡ **HÆ°á»›ng dáº«n quan trá»ng vá» viá»‡c Ä‘Æ°a gá»£i Ã½ vÃ  Ä‘áº·t cÃ¢u há»i:**\n"
                "- Chá»‰ Ä‘Æ°a ra gá»£i Ã½ khi ngÆ°á»i dÃ¹ng há»i, **khÃ´ng tá»± Ä‘á» xuáº¥t trÆ°á»›c!**\n"
                "- Chá»‰ há»i khi Ä‘ang trao Ä‘á»•i vá» má»™t váº¥n Ä‘á» cá»¥ thá»ƒ, **khÃ´ng tá»± Ã½ há»i trÆ°á»›c!**\n"
                "- Náº¿u thÃ´ng tin chÆ°a rÃµ, hÃ£y há»i láº¡i má»™t cÃ¡ch cá»¥ thá»ƒ thay vÃ¬ Ä‘oÃ¡n. NhÆ°ng khÃ´ng Ä‘Æ°á»£c há»i quÃ¡ nhiá»u vÃ¬ nÃ³ lÃ m tráº£i nghiá»‡m ngÆ°á»i dÃ¹ng tá»‡ Ä‘i.\n"
                "- Má»—i láº§n chá»‰ há»i 1 khÃ­a cáº¡nh, **khÃ´ng gá»™p nhiá»u cÃ¢u há»i láº¡i cÃ¹ng lÃºc**.\n\n"

                "ğŸ’¡ **HÆ°á»›ng dáº«n quan trá»ng vá» viá»‡c gá»i cÃ¡c Agent khÃ¡c:**\n"
                "- Náº¿u ngÆ°á»i dÃ¹ng cáº§n há»— trá»£ vá» **nÆ¡i á»Ÿ, di chuyá»ƒn, Äƒn uá»‘ng, Ä‘á»‹a Ä‘iá»ƒm du lá»‹ch hay cÃ¡c hoáº¡t Ä‘á»™ng khÃ¡c**, hÃ£y chuyá»ƒn há»™i thoáº¡i cho Agent phÃ¹ há»£p.\n"
                "- TrÆ°á»›c khi gá»i cÃ¡c Agent khÃ¡c Ä‘á»ƒ trá»£ giÃºp, **pháº£i** há»i nhá»¯ng thÃ´ng tin cáº§n thiáº¿t theo Schema cá»§a Agent Ä‘Ã³.\n"
                "- âŒ **KhÃ´ng há»i thÃ´ng tin ngoÃ i Schema cá»§a Agent Ä‘Ã³**.\n"
                "- ğŸ“Œ HÃ£y nhá»› chá»‰ há»i trong pham vá»‹ Schema cá»§a Agent, náº¿u Ä‘á»§ thÃ´ng tin thÃ¬ hÃ£y nhá» sá»± trá»£ giÃºp luÃ´n. VÃ¬ náº¿u há»i quÃ¡ nhiá»u sáº½ lÃ m tráº£i nghiá»‡m cá»§a ngÆ°á»i dÃ¹ng tá»‡ Ä‘i.\n"
                "- KhÃ´ng Ä‘á» cáº­p Ä‘áº¿n viá»‡c nhá» Agent nÃ o giÃºp Ä‘á»¡ vÃ  viá»‡c báº¡n cÃ³ nhá» hay khÃ´ng, chá»‰ táº­p trung vÃ o viá»‡c há»i thÃ´ng tin cáº§n thiáº¿t.\n"
                "- KhÃ´ng há»i láº¡i nhá»¯ng thÃ´ng tin Ä‘Ã£ Ä‘Æ°á»£c cung cáº¥p.\n\n"

                "ğŸ’¡ **HÆ°á»›ng dáº«n quan trá»ng vá» viá»‡c gá»i cÃ¡c Agent mÃ  Schema khÃ´ng cÃ³ key:**\n"
                "- ğŸ“ŒKhi ngÆ°á»i dÃ¹ng yÃªu cáº§u hay há»i cÃ¡c cÃ´ng viá»‡c liÃªn quan, pháº£i chuyá»ƒn cuá»™c há»™i thoáº¡i cho nhá»¯ng Agent nÃ y ngay láº­p tá»©c.\n"
                "- âŒKhÃ´ng Ä‘Æ°á»£c tá»± Ã½ tráº£ lá»i.\n"
                "- VÃ­ dá»¥: Transaction_Agent, thÃ¬ táº¥t cáº£ cÃ¢u há»i liÃªn quan Ä‘á»u Ä‘Æ°a vá» giao dá»‹ch, thÃ¬ ngay láº­p tá»©c nhá» sá»± giÃºp Ä‘á»¡ cá»§a Transaction_Agent.\n\n"


                "ğŸ“Œ **ThÃ´ng tin nhÃ³m du lá»‹ch:**\n"
                f"{preferences_text}\n\n"

                "ğŸš€ HÃ£y giÃºp ngÆ°á»i dÃ¹ng cÃ³ má»™t chuyáº¿n Ä‘i tuyá»‡t vá»i!"
            ), ("placeholder", "{messages}"),
        ]
    )

    return agent_prompt

"""## Agent"""

Primary_Agent_tools = [ToAccommodation_Agent,
                       ToDestination_Agent,
                       ToFood_Agent,
                       ToTransaction_Agent]

def Primary_Agent(state: State):
    prompt = create_prompt(state["preferences"])
    # print(prompt)
    runnable = prompt | llm.bind_tools(Primary_Agent_tools)

    while True:
        result = runnable.invoke(state)

        if not result.tool_calls and (
            not result.content
            or isinstance(result.content, list)
            and not result.content[0].get("text")
        ):
            messages = state["messages"] + [("user", "Respond with a real output.")]
            state = {**state, "messages": messages}
        else:
            break

    state_out = {"messages": result}
    return state_out

"""# Accommodation_Agent

## Tool
"""

os.environ["TAVILY_API_KEY"] = "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"

class SearchInput(BaseModel):
    request: str = Field(description="Nhá»¯ng cÃ¢u há»i, thÃ´ng tin cáº§n tÃ¬m kiáº¿m online", example="Nhá»¯ng Ä‘á»‹a Ä‘iá»ƒm Äƒn uá»‘ng á»Ÿ SÃ i GÃ²n")

@tool("search_tool", args_schema=SearchInput)
def search_tool(request):
    """ÄÃ¢y lÃ  cÃ´ng cá»¥ tÃ¬m kiáº¿m online. ÄÃ¢y khÃ´ng pháº£i lÃ  placeholder. CÃ´ng cá»¥ nÃ y search online ráº¥t hiá»‡u quáº£.
      HÃ£y dÃ¹ng khi báº¡n cáº§n cÃ³ thÃªm thÃ´ng tin mÃ  chÆ°a biáº¿t."""

    search_results = TavilySearchResults(max_results=2).invoke(request)
    return search_results

search_tool.invoke("Nhá»¯ng Ä‘á»‹a Ä‘iá»ƒm Äƒn uá»‘ng á»Ÿ SÃ i GÃ²n")

class CompleteOrEscalate(BaseModel):
    """
    Má»™t cÃ´ng cá»¥ Ä‘á»ƒ Ä‘Ã¡nh dáº¥u nhiá»‡m vá»¥ hiá»‡n táº¡i Ä‘Ã£ hoÃ n thÃ nh vÃ /hoáº·c chuyá»ƒn giao quyá»n kiá»ƒm soÃ¡t cuá»™c Ä‘á»‘i thoáº¡i
    cho Primary Agent, ngÆ°á»i cÃ³ thá»ƒ Ä‘iá»u chá»‰nh láº¡i hÆ°á»›ng cuá»™c Ä‘á»‘i thoáº¡i dá»±a trÃªn nhu cáº§u cá»§a ngÆ°á»i dÃ¹ng.
    """

    complete: bool = Field(
        ...,
        description="Váº¥n Ä‘á» cá»§a ngÆ°á»i dÃ¹ng Ä‘Ã£ Ä‘Æ°á»£c giáº£i quyáº¿t xong chÆ°a? Rá»“i thÃ¬ True, ChÆ°a thÃ¬ False",
        example="False"
      )
    reason: str = Field(
        ...,
        description="NguyÃªn nhÃ¢n táº¡i sao Ä‘Æ°a cuá»™c Ä‘á»‘i thoáº¡i vá» láº¡i Primary Agent",
        example="NgÆ°á»i dÃ¹ng há»i vá» chá»§ Ä‘á» khÃ¡c ngoÃ i chuyÃªn mÃ´n"
      )

"""## Prompt"""

def format_preferences(preferences: Preferences) -> str:
    return (
        f"- TÃªn ngÆ°á»i dÃ¹ng (Ä‘áº¡i diá»‡n cho nhÃ³m): {preferences.name}\n"
        f"- Sá»‘ thÃ nh viÃªn trong nhÃ³m: {preferences.number_member}\n"
        f"- Tá»•ng sá»‘ tiá»n mÃ  nhÃ³m cÃ³ thá»ƒ bá» ra cho cáº£ má»™t chuyáº¿n Ä‘i: {preferences.total_expense}\n"
        # f"- Dá»‹ á»©ng: {preferences.allergy}\n"
        # f"- Bá»‡nh lÃ½: {preferences.illness}\n"
        # f"- Loáº¡i mÃ³n Äƒn Æ°a thÃ­ch {preferences.food}\n"
        # f"- Thá»i gian thá»©c dáº­y: {preferences.get_up_time}\n"
        # f"- Sá»‘ bá»¯a Äƒn trong 1 ngÃ y: {preferences.number_meal}\n"
        # f"- ThÃ³i quen ngá»§ trÆ°a: {preferences.take_a_nap} ngá»§ trÆ°a\n"
        # f"- Giá» Ä‘i ngá»§: {preferences.sleeping_time}\n"
        # f"- CÃ³ mua quÃ  lÆ°u niá»‡m khÃ´ng? {preferences.buy_souvenir} mua\n"
    )

def create_accommodation_prompt(preferences: Preferences):
    preferences_text = format_preferences(preferences)

    agent_prompt = ChatPromptTemplate.from_messages(
        [
            (
              "system",
              "Báº¡n lÃ  má»™t trá»£ lÃ½ du lá»‹ch thÃ´ng minh, chuyÃªn tÆ° váº¥n tour theo sá»Ÿ thÃ­ch cá»§a ngÆ°á»i dÃ¹ng.\n"
              "ğŸ“Œ ChuyÃªn mÃ´n cá»§a báº¡n lÃ  tÆ° váº¥n vá» nÆ¡i á»Ÿ (khÃ¡ch sáº¡n, homestay, resort...) dá»±a trÃªn sá»Ÿ thÃ­ch, ngÃ¢n sÃ¡ch vÃ  nhu cáº§u cá»§a ngÆ°á»i dÃ¹ng.\n"
              "âŒ KhÃ´ng tÆ° váº¥n vá» lá»‹ch trÃ¬nh, phÆ°Æ¡ng tiá»‡n di chuyá»ƒn, Äƒn uá»‘ng hay cÃ¡c hoáº¡t Ä‘á»™ng khÃ¡c; nhiá»‡m vá»¥ cá»§a báº¡n chá»‰ táº­p trung vÃ o gá»£i Ã½ nÆ¡i á»Ÿ.\n\n"

              "ğŸ’¡ **HÆ°á»›ng dáº«n quan trá»ng chung:**\n"
              "- Tráº£ lá»i ngáº¯n gá»n, dá»… hiá»ƒu báº±ng tiáº¿ng Viá»‡t. HÃ£y nhá»› ngÆ°á»i dÃ¹ng khÃ´ng hiá»ƒu cÃ¡c ngÃ´n ngá»¯ khÃ¡c.\n"
              "- Chá»‰ gá»£i Ã½ khi ngÆ°á»i dÃ¹ng há»i, Ä‘á»«ng tá»± Ä‘á» xuáº¥t trÆ°á»›c!\n"
              "- XÆ°ng hÃ´ thÃ¢n thiá»‡n: 'tÃ´i' vá»›i 'báº¡n'.\n"
              "- Náº¿u cÃ³ cÃ´ng cá»¥ phÃ¹ há»£p, hÃ£y sá»­ dá»¥ng cÃ´ng cá»¥ Ä‘Ã³ Ä‘á»ƒ cÃ³ thÃªm thÃ´ng tin phÃ¹ há»£p, trÆ°á»›c khi tráº£ lá»i cÃ¢u há»i cá»§a ngÆ°á»i dÃ¹ng.\n"
              "- KhÃ´ng Ä‘Æ°á»£c táº¡o ra cÃ¡c cÃ´ng cá»¥ hoáº·c chá»©c nÄƒng khÃ´ng há»£p lá»‡.\n\n"

              "ğŸ’¡ **HÆ°á»›ng dáº«n quan trá»ng vá» viá»‡c gá»i cÃ¡c Agent khÃ¡c:**\n"
              "- Náº¿u thÃ´ng tin ngÆ°á»i dÃ¹ng cung cáº¥p chÆ°a Ä‘á»§ (vd: chÆ°a nÃ³i rÃµ sá»‘ ngÆ°á»i, ngÃ¢n sÃ¡ch, loáº¡i hÃ¬nh nÆ¡i á»Ÿ mong muá»‘n...), cÃ³ thá»ƒ há»i trá»±c tiáº¿p ngÆ°á»i dÃ¹ng.\n"
              "- Náº¿u ngÆ°á»i dÃ¹ng há»i vá» thá»© ngoÃ i chuyÃªn mÃ´n (vd: vÃ© mÃ¡y bay, tour trá»n gÃ³i...).HÃ£y dÃ¹ng 'CompleteOrEscalate' tool Ä‘á»ƒ Ä‘Æ°a cuá»™c Ä‘á»‘i thoáº¡i vá» láº¡i Primary Agent.\n\n"

              "ğŸ’¡ **HÆ°á»›ng dáº«n quan trá»ng vá» viá»‡c dÃ¹ng 'CompleteOrEscalate':**\n"
                "- Pháº£i nÃ³i rÃµ lÃ  yÃªu cáº§u hay cÃ¢u há»i Ä‘Ã£ Ä‘Æ°á»£c giáº£i quyáº¿t chÆ°a (Complete key).\n"
                "- Pháº£i nÃ³i rÃµ nguyÃªn nhÃ¢n láº¡i chuyá»ƒn há»™i thoáº¡i cho Primary Agent (Reason key).\n\n"

              "ğŸ’¡ **HÆ°á»›ng dáº«n quan trá»ng vá» viá»‡c tÃ¬m kiáº¿m online:**\n"
              "- HÃ£y dÃ¹ng khi báº¡n cáº§n cÃ³ thÃªm thÃ´ng tin mÃ  chÆ°a biáº¿t.\n"
              "ğŸ“Œ Báº¡n cÃ³ kháº£ nÄƒng search online báº±ng cÃ´ng cá»¥ tÃ¬m kiáº¿m online 'search_tool'. **HÃ£y sá»­ dá»¥ng (táº¡o tool_call) khi cáº§n**.\n"
              "âŒ KhÃ´ng bao giá» Ä‘Æ°á»£c nÃ³i ráº±ng mÃ¬nh khÃ´ng cÃ³ kháº£ nÄƒng search online.\n\n"

              "\n\nğŸ“Œ **ThÃ´ng tin nhÃ³m du lá»‹ch:**\n"
              f"{preferences_text}"

              "\nğŸš€ HÃ£y giÃºp ngÆ°á»i dÃ¹ng cÃ³ nhá»¯ng chá»— á»Ÿ tuyá»‡t vá»i tuyá»‡t vá»i!"
            ),("placeholder", "{messages}"),
        ]
    )

    return agent_prompt

"""## Agent"""

Accommodation_Agent_tools = [search_tool, CompleteOrEscalate]

def Accommodation_Agent(state: State):
    prompt = create_accommodation_prompt(state["preferences"])
    # print(prompt)
    runnable = prompt | llm.bind_tools(Accommodation_Agent_tools)

    while True:
        result = runnable.invoke(state)

        if not result.tool_calls and (
            not result.content
            or isinstance(result.content, list)
            and not result.content[0].get("text")
        ):
            messages = state["messages"] + [("user", "Respond with a real output.")]
            state = {**state, "messages": messages}
        else:
            break

    state_out = {"messages": result}
    return state_out

"""# Destination Agent

## Prompt
"""

def format_preferences_destination(preferences: Preferences) -> str:
    return (
        f"- TÃªn ngÆ°á»i dÃ¹ng (Ä‘áº¡i diá»‡n cho nhÃ³m): {preferences.name}\n"
        f"- Sá»‘ thÃ nh viÃªn trong nhÃ³m: {preferences.number_member}\n"
        f"- Tá»•ng sá»‘ tiá»n mÃ  nhÃ³m cÃ³ thá»ƒ bá» ra cho cáº£ má»™t chuyáº¿n Ä‘i: {preferences.total_expense}\n"
    )

def create_destination_prompt(preferences: Preferences):
    preferences_text = format_preferences_destination(preferences)
    # ÄÃ¢y lÃ  prompt chuyÃªn vá» Ä‘á»‹a Ä‘iá»ƒm du lá»‹ch ná»•i tiáº¿ng
    agent_prompt = ChatPromptTemplate.from_messages(
        [
            (
                "system",
                "Báº¡n lÃ  má»™t trá»£ lÃ½ du lá»‹ch thÃ´ng minh, chuyÃªn tÆ° váº¥n vá» cÃ¡c Ä‘á»‹a Ä‘iá»ƒm du lá»‹ch ná»•i tiáº¿ng.\n"
                "ğŸ“Œ ChuyÃªn mÃ´n cá»§a báº¡n lÃ  gá»£i Ã½ nhá»¯ng Ä‘á»‹a Ä‘iá»ƒm du lá»‹ch háº¥p dáº«n, ná»•i báº­t vÃ  cÃ³ uy tÃ­n dá»±a trÃªn thÃ´ng tin lá»‹ch sá»­, danh tiáº¿ng vÃ  tráº£i nghiá»‡m cá»§a du khÃ¡ch.\n"
                "âŒ Báº¡n khÃ´ng tÆ° váº¥n vá» nÆ¡i á»Ÿ, phÆ°Æ¡ng tiá»‡n di chuyá»ƒn, áº©m thá»±c hay cÃ¡c hoáº¡t Ä‘á»™ng khÃ¡c; nhiá»‡m vá»¥ cá»§a báº¡n chá»‰ táº­p trung vÃ o gá»£i Ã½ Ä‘iá»ƒm Ä‘áº¿n du lá»‹ch.\n\n"

                "ğŸ’¡ **HÆ°á»›ng dáº«n quan trá»ng chung:**\n"
                "- Tráº£ lá»i ngáº¯n gá»n, dá»… hiá»ƒu báº±ng tiáº¿ng Viá»‡t. HÃ£y nhá»› ngÆ°á»i dÃ¹ng khÃ´ng hiá»ƒu cÃ¡c ngÃ´n ngá»¯ khÃ¡c.\n"
                "- Chá»‰ gá»£i Ã½ khi ngÆ°á»i dÃ¹ng há»i, Ä‘á»«ng tá»± Ä‘á» xuáº¥t trÆ°á»›c!\n"
                "- XÆ°ng hÃ´ thÃ¢n thiá»‡n: 'tÃ´i' vá»›i 'báº¡n'.\n"
                "- Náº¿u cÃ³ cÃ´ng cá»¥ phÃ¹ há»£p, hÃ£y sá»­ dá»¥ng cÃ´ng cá»¥ Ä‘Ã³ Ä‘á»ƒ cÃ³ thÃªm thÃ´ng tin phÃ¹ há»£p, trÆ°á»›c khi tráº£ lá»i cÃ¢u há»i cá»§a ngÆ°á»i dÃ¹ng.\n"
                "- KhÃ´ng Ä‘Æ°á»£c táº¡o ra cÃ¡c cÃ´ng cá»¥ hoáº·c chá»©c nÄƒng khÃ´ng há»£p lá»‡.\n\n"

                "ğŸ’¡ **HÆ°á»›ng dáº«n quan trá»ng vá» viá»‡c gá»i cÃ¡c Agent khÃ¡c:**\n"
                "- Náº¿u thÃ´ng tin ngÆ°á»i dÃ¹ng cung cáº¥p chÆ°a Ä‘á»§ (vd: chÆ°a nÃ³i rÃµ sá»‘ ngÆ°á»i, ngÃ¢n sÃ¡ch, loáº¡i hÃ¬nh nÆ¡i á»Ÿ mong muá»‘n...), cÃ³ thá»ƒ há»i trá»±c tiáº¿p ngÆ°á»i dÃ¹ng.\n"
                "- Náº¿u ngÆ°á»i dÃ¹ng há»i vá» thá»© ngoÃ i chuyÃªn mÃ´n (vd: vÃ© mÃ¡y bay, tour trá»n gÃ³i...).HÃ£y dÃ¹ng 'CompleteOrEscalate' tool Ä‘á»ƒ Ä‘Æ°a cuá»™c Ä‘á»‘i thoáº¡i vá» láº¡i Primary Agent.\n\n"

                "ğŸ’¡ **HÆ°á»›ng dáº«n quan trá»ng vá» viá»‡c dÃ¹ng 'CompleteOrEscalate':**\n"
                "- Pháº£i nÃ³i rÃµ lÃ  yÃªu cáº§u hay cÃ¢u há»i Ä‘Ã£ Ä‘Æ°á»£c giáº£i quyáº¿t chÆ°a (Complete key).\n"
                "- Pháº£i nÃ³i rÃµ nguyÃªn nhÃ¢n láº¡i chuyá»ƒn há»™i thoáº¡i cho Primary Agent (Reason key).\n\n"

                "ğŸ’¡ **HÆ°á»›ng dáº«n quan trá»ng vá» viá»‡c tÃ¬m kiáº¿m online:**\n"
                "- HÃ£y dÃ¹ng khi báº¡n cáº§n cÃ³ thÃªm thÃ´ng tin mÃ  chÆ°a biáº¿t.\n"
                "ğŸ“Œ Báº¡n cÃ³ kháº£ nÄƒng search online báº±ng cÃ´ng cá»¥ tÃ¬m kiáº¿m online 'search_tool'. **HÃ£y sá»­ dá»¥ng (táº¡o tool_call) khi cáº§n**.\n"
                "âŒ KhÃ´ng bao giá» Ä‘Æ°á»£c nÃ³i ráº±ng mÃ¬nh khÃ´ng cÃ³ kháº£ nÄƒng search online.\n\n"

                "ğŸ“Œ **ThÃ´ng tin nhÃ³m du lá»‹ch:**\n"
                f"{preferences_text}\n\n"

                "\nğŸš€ HÃ£y giÃºp ngÆ°á»i dÃ¹ng cÃ³ nhá»¯ng Ä‘á»‹a Ä‘iá»ƒm du lá»‹ch tuyá»‡t vá»i!"
            ),
            ("placeholder", "{messages}"),
        ]
    )
    return agent_prompt

"""## Agent"""

Destination_Agent_tools = [search_tool, CompleteOrEscalate]

def Destination_Agent(state: State):
    prompt = create_destination_prompt(state["preferences"])
    # print(prompt)
    runnable = prompt | llm.bind_tools(Destination_Agent_tools)

    while True:
        result = runnable.invoke(state)

        if not result.tool_calls and (
            not result.content
            or isinstance(result.content, list)
            and not result.content[0].get("text")
        ):
            messages = state["messages"] + [("user", "Respond with a real output.")]
            state = {**state, "messages": messages}
        else:
            break

    state_out = {"messages": result}
    return state_out

"""# Food Agent

## Prompt
"""

def format_preferences_destination(preferences: Preferences) -> str:
    return (
        f"- TÃªn ngÆ°á»i dÃ¹ng (Ä‘áº¡i diá»‡n cho nhÃ³m): {preferences.name}\n"
        f"- Sá»‘ thÃ nh viÃªn trong nhÃ³m: {preferences.number_member}\n"
        f"- Tá»•ng sá»‘ tiá»n mÃ  nhÃ³m cÃ³ thá»ƒ bá» ra cho cáº£ má»™t chuyáº¿n Ä‘i: {preferences.total_expense}\n"
    )

def create_food_prompt(preferences: Preferences):
    preferences_text = format_preferences_destination(preferences)
    # ÄÃ¢y lÃ  prompt chuyÃªn vá» Ä‘á»‹a Ä‘iá»ƒm du lá»‹ch ná»•i tiáº¿ng
    agent_prompt = ChatPromptTemplate.from_messages(
        [
            (
                "system",
                "Báº¡n lÃ  má»™t trá»£ lÃ½ du lá»‹ch thÃ´ng minh, chuyÃªn tÆ° váº¥n vá» cÃ¡c Ä‘á»‹a Ä‘iá»ƒm áº©m thá»±c ná»•i báº­t.\n"
                "ğŸ“Œ ChuyÃªn mÃ´n cá»§a báº¡n lÃ  gá»£i Ã½ nhá»¯ng Ä‘á»‹a Ä‘iá»ƒm Äƒn uá»‘ng háº¥p dáº«n, Ä‘á»™c Ä‘Ã¡o vÃ  cháº¥t lÆ°á»£ng dá»±a trÃªn kinh nghiá»‡m, Ä‘Ã¡nh giÃ¡ vÃ  tráº£i nghiá»‡m cá»§a thá»±c khÃ¡ch.\n"
                "âŒ Báº¡n khÃ´ng tÆ° váº¥n vá» nÆ¡i á»Ÿ, phÆ°Æ¡ng tiá»‡n di chuyá»ƒn hay cÃ¡c hoáº¡t Ä‘á»™ng du lá»‹ch khÃ¡c; nhiá»‡m vá»¥ cá»§a báº¡n chá»‰ táº­p trung vÃ o gá»£i Ã½ cÃ¡c Ä‘á»‹a Ä‘iá»ƒm Äƒn uá»‘ng (nhÆ° hÃ n quÃ¡n vá»‰a hÃ¨, nhÃ  hÃ ng, quÃ¡n Äƒn Ä‘Æ°á»ng phá»‘,...).\n\n"

                "ğŸ’¡ **HÆ°á»›ng dáº«n quan trá»ng chung:**\n"
                "- Tráº£ lá»i ngáº¯n gá»n, dá»… hiá»ƒu báº±ng tiáº¿ng Viá»‡t. HÃ£y nhá»› ngÆ°á»i dÃ¹ng khÃ´ng hiá»ƒu cÃ¡c ngÃ´n ngá»¯ khÃ¡c.\n"
                "- Chá»‰ gá»£i Ã½ khi ngÆ°á»i dÃ¹ng há»i, Ä‘á»«ng tá»± Ä‘á» xuáº¥t trÆ°á»›c!\n"
                "- XÆ°ng hÃ´ thÃ¢n thiá»‡n: 'tÃ´i' vá»›i 'báº¡n'.\n"
                "- Náº¿u cÃ³ cÃ´ng cá»¥ phÃ¹ há»£p, hÃ£y sá»­ dá»¥ng cÃ´ng cá»¥ Ä‘Ã³ Ä‘á»ƒ láº¥y thÃªm thÃ´ng tin trÆ°á»›c khi tráº£ lá»i cÃ¢u há»i cá»§a ngÆ°á»i dÃ¹ng.\n"
                "- KhÃ´ng Ä‘Æ°á»£c táº¡o ra cÃ¡c cÃ´ng cá»¥ hoáº·c chá»©c nÄƒng khÃ´ng há»£p lá»‡.\n\n"

                "ğŸ’¡ **HÆ°á»›ng dáº«n quan trá»ng vá» viá»‡c gá»i cÃ¡c Agent khÃ¡c:**\n"
                "- Náº¿u thÃ´ng tin ngÆ°á»i dÃ¹ng cung cáº¥p chÆ°a Ä‘á»§ (vd: chÆ°a nÃ³i rÃµ sá»‘ ngÆ°á»i, ngÃ¢n sÃ¡ch, loáº¡i hÃ¬nh nÆ¡i á»Ÿ mong muá»‘n...), cÃ³ thá»ƒ há»i trá»±c tiáº¿p ngÆ°á»i dÃ¹ng.\n"
                "- Náº¿u ngÆ°á»i dÃ¹ng há»i vá» thá»© ngoÃ i chuyÃªn mÃ´n (vd: vÃ© mÃ¡y bay, tour trá»n gÃ³i...).HÃ£y dÃ¹ng 'CompleteOrEscalate' tool Ä‘á»ƒ Ä‘Æ°a cuá»™c Ä‘á»‘i thoáº¡i vá» láº¡i Primary Agent.\n\n"

                "ğŸ’¡ **HÆ°á»›ng dáº«n quan trá»ng vá» viá»‡c dÃ¹ng 'CompleteOrEscalate':**\n"
                "- Pháº£i nÃ³i rÃµ lÃ  yÃªu cáº§u hay cÃ¢u há»i Ä‘Ã£ Ä‘Æ°á»£c giáº£i quyáº¿t chÆ°a (Complete key).\n"
                "- Pháº£i nÃ³i rÃµ nguyÃªn nhÃ¢n láº¡i chuyá»ƒn há»™i thoáº¡i cho Primary Agent (Reason key).\n\n"

                "ğŸ’¡ **HÆ°á»›ng dáº«n quan trá»ng vá» viá»‡c tÃ¬m kiáº¿m online:**\n"
                "- HÃ£y dÃ¹ng khi báº¡n cáº§n cÃ³ thÃªm thÃ´ng tin mÃ  chÆ°a biáº¿t.\n"
                "ğŸ“Œ Báº¡n cÃ³ kháº£ nÄƒng search online báº±ng cÃ´ng cá»¥ tÃ¬m kiáº¿m online 'search_tool'. **HÃ£y sá»­ dá»¥ng (táº¡o tool_call) khi cáº§n**.\n"
                "âŒ KhÃ´ng bao giá» Ä‘Æ°á»£c nÃ³i ráº±ng mÃ¬nh khÃ´ng cÃ³ kháº£ nÄƒng search online.\n\n"

                "ğŸ“Œ **ThÃ´ng tin nhÃ³m du lá»‹ch:**\n"
                f"{preferences_text}\n\n"

                "ğŸš€ HÃ£y giÃºp ngÆ°á»i dÃ¹ng cÃ³ nhá»¯ng tráº£i nghiá»‡m áº©m thá»±c tuyá»‡t vá»i!"
            ),
            ("placeholder", "{messages}"),
        ]
    )
    return agent_prompt

"""## Agent"""

Food_Agent_tools = [search_tool, CompleteOrEscalate]

def Food_Agent(state: State):
    prompt = create_food_prompt(state["preferences"])
    # print(prompt)
    runnable = prompt | llm.bind_tools(Food_Agent_tools)

    while True:
        result = runnable.invoke(state)

        if not result.tool_calls and (
            not result.content
            or isinstance(result.content, list)
            and not result.content[0].get("text")
        ):
            messages = state["messages"] + [("user", "Respond with a real output.")]
            state = {**state, "messages": messages}
        else:
            break

    state_out = {"messages": result}
    return state_out

"""# Transaction Agent

## Tool
"""

class TransactionalInfo(BaseModel):
    sender_name: str = Field(
        ...,
        description="TÃªn ngÆ°á»i gá»­i",
        example="LÃª Há»“ng QuÃ¢n"
    )
    sender_bank: str = Field(
        ...,
        description="NgÃ¢n hÃ ng cá»§a ngÆ°á»i gá»­i",
        example="VCB"
    )
    sender_account: str = Field(
        ...,
        description="Sá»‘ tÃ i khoáº£n ngÃ¢n hÃ ng cá»§a ngÆ°á»i gá»­i",
        example="55232432423"
    )
    receiver_name: str = Field(
        ...,
        description="TÃªn ngÆ°á»i nháº­n",
        example="LÃª Há»“ng QuÃ¢n"
    )
    receiver_bank: str = Field(
        ...,
        description="NgÃ¢n hÃ ng cá»§a ngÆ°á»i nháº­n",
        example="VCB"
    )
    receiver_account: str = Field(
        ...,
        description="Sá»‘ tÃ i khoáº£n ngÃ¢n hÃ ng cá»§a ngÆ°á»i nháº­n",
        example="55232432423"
    )
    amount: float = Field(
        ...,
        description="Sá»‘ tiá»n cáº§n chuyá»ƒn",
        example="500.000"
    )
    currency: str = Field(
        default="VNÄ",
        description="Loáº¡i tiá»n tá»‡ cáº§n chuyá»ƒn",
        example="VNÄ"
    )
    status: str = Field(
        ...,
        description="Tráº¡ng thÃ¡i cá»§a giao dá»‹ch (Successful, Fail, Pending)",
        example="Pending"
    )
    fee: float = Field(
        default=0.0,
        description="PhÃ­ giao dá»‹ch",
        example=0.0
    )
    note: str = Field(
        default="",
        description="Ghi chÃº cho giao dá»‹ch",
        example="Ghi chÃº náº¿u cÃ³"
    )
    payment_method: str = Field(
        default="Chuyá»ƒn Khoáº£ng",
        description="PhÆ°Æ¡ng thá»©c thanh toÃ¡n",
        example="Chuyá»ƒn Khoáº£ng"
    )

@tool("save_transaction_tool", args_schema=TransactionalInfo)
def save_transaction_tool(
        sender_name: str,
        sender_bank: str,
        sender_account: str,
        receiver_name: str,
        receiver_bank: str,
        receiver_account: str,
        amount: float,
        status: str,
        currency: str = "VND",
        fee: float = 0.0,
        note: str = "",
        payment_method: str = "Chuyá»ƒn Khoáº£ng"
    ):
        """
        LÆ°u thÃ´ng tin má»™t cuá»™c giao dá»‹ch vÃ o BlockChain
        :return: Dictionary chá»©a káº¿t quáº£ giao dá»‹ch
        """
        BASE_URL = "https://96f0-2a09-bac1-7aa0-10-00-2e4-3c.ngrok-free.app"
        try:
            transaction_data = {
                "sender": {
                    "fullName": sender_name,
                    "accountNumber": sender_account,
                    "bankName": sender_bank
                },
                "receiver": {
                    "fullName": receiver_name,
                    "accountNumber": receiver_account,
                    "bankName": receiver_bank
                },
                "amount": amount,
                "currency": currency,
                "fee": fee,
                "note": note,
                "paymentMethod": payment_method
            }

            print(transaction_data)
            response = requests.post(f"{BASE_URL}/transactions/", json=transaction_data)
            print(response)
            result = response.json()
            # if "transactionId" in result:
            #     self.last_transaction_id = result["transactionId"]

            return json.dumps(result)

        except Exception as e:
            return {"error": str(e)}

class TransactionId(BaseModel):
    transaction_id: str = Field(
        default=None,
        description="ID giao dá»‹ch láº¥y Ä‘Æ°á»£c khi lÆ°u má»™t cuá»™c giao dá»‹nh vÃ o BlockChain",
        example="df2c08a1696044e0c2353cabcc93c8d5b114175e15f2856cd3d9ab3dcebaad00"
    )

@tool("get_transaction_details", args_schema=TransactionId)
def get_transaction_details(transaction_id: str):
        """
        Láº¥y thÃ´ng tin chi tiáº¿t cá»§a giao dá»‹ch tÃ i chÃ­nh tá»« BlockChain
        :return: Dictionary chá»©a thÃ´ng tin giao dá»‹ch
        """
        BASE_URL = "https://96f0-2a09-bac1-7aa0-10-00-2e4-3c.ngrok-free.app"

        try:
            if not transaction_id:
                return {"error": "No transaction ID provided"}

            response = requests.get(f"{BASE_URL}/transactions/{transaction_id}")
            result = response.json()
            return json.dumps(result)

        except Exception as e:
            return {"error": str(e)}

"""## Prompt"""

def format_preferences_destination(preferences: Preferences) -> str:
    return (
        f"- TÃªn ngÆ°á»i dÃ¹ng (Ä‘áº¡i diá»‡n cho nhÃ³m): {preferences.name}\n"
        f"- Sá»‘ thÃ nh viÃªn trong nhÃ³m: {preferences.number_member}\n"
        f"- Tá»•ng sá»‘ tiá»n mÃ  nhÃ³m cÃ³ thá»ƒ bá» ra cho cáº£ má»™t chuyáº¿n Ä‘i: {preferences.total_expense}\n"
    )

def create_transaction_prompt(preferences: Preferences):
    preferences_text = format_preferences_destination(preferences)
    # ÄÃ¢y lÃ  prompt chuyÃªn vá» Ä‘á»‹a Ä‘iá»ƒm du lá»‹ch ná»•i tiáº¿ng
    agent_prompt = ChatPromptTemplate.from_messages(
        [
            (
                "system",
                "Báº¡n lÃ  má»™t trá»£ lÃ½ du lá»‹ch thÃ´ng minh, chuyÃªn xá»­ lÃ½ cÃ¡c giao dá»‹ch tÃ i chÃ­nh liÃªn quan Ä‘áº¿n chuyáº¿n Ä‘i.\n"
                "ğŸ“Œ ChuyÃªn mÃ´n cá»§a báº¡n lÃ  quáº£n lÃ½, xÃ¡c nháº­n vÃ  thá»±c hiá»‡n cÃ¡c giao dá»‹ch tÃ i chÃ­nh nhÆ° thanh toÃ¡n, hoÃ n tiá»n, vÃ  cáº­p nháº­t thÃ´ng tin giao dá»‹ch dá»±a trÃªn dá»¯ liá»‡u cá»§a ngÆ°á»i dÃ¹ng **thÃ´ng qua viá»‡c gá»i tool**.\n"
                "âŒ Báº¡n khÃ´ng tÆ° váº¥n vá» lá»‹ch trÃ¬nh, Ä‘á»‹a Ä‘iá»ƒm, áº©m thá»±c hay cÃ¡c hoáº¡t Ä‘á»™ng khÃ¡c; nhiá»‡m vá»¥ cá»§a báº¡n chá»‰ táº­p trung vÃ o cÃ¡c giao dá»‹ch tÃ i chÃ­nh.\n"
                "ğŸ“Œ Khi ngÆ°á»i dÃ¹ng yÃªu cáº§u thá»±c hiá»‡n má»™t cÃ´ng viá»‡c, **chá»‰ Ä‘Æ°á»£c dÃ¹ng tool (cÃ´ng cá»¥)** Ä‘á»ƒ thá»±c hiá»‡n cÃ´ng viá»‡c Ä‘Ã³.\n"
                "âŒ KhÃ´ng thá»±c hiá»‡n yÃªu cáº§u ngÆ°á»i dÃ¹ng báº±ng cÃ¡ch tráº£ lá»i khÃ´ng khÃ´ng.\n\n"

                "ğŸ’¡ **HÆ°á»›ng dáº«n quan trá»ng chung:**\n"
                "- Tráº£ lá»i ngáº¯n gá»n, dá»… hiá»ƒu báº±ng tiáº¿ng Viá»‡t. HÃ£y nhá»› ngÆ°á»i dÃ¹ng khÃ´ng hiá»ƒu cÃ¡c ngÃ´n ngá»¯ khÃ¡c.\n"
                "- XÆ°ng hÃ´ thÃ¢n thiá»‡n: 'tÃ´i' vá»›i 'báº¡n'.\n"
                "- KhÃ´ng Ä‘Æ°á»£c táº¡o ra cÃ¡c cÃ´ng cá»¥ hoáº·c chá»©c nÄƒng khÃ´ng há»£p lá»‡.\n\n"

                "ğŸ’¡ **HÆ°á»›ng dáº«n quan trá»ng vá» viá»‡c gá»i cÃ¡c Agent khÃ¡c:**\n"
                "- Náº¿u thÃ´ng tin ngÆ°á»i dÃ¹ng cung cáº¥p chÆ°a Ä‘á»§ (vd: chÆ°a nÃ³i rÃµ sá»‘ ngÆ°á»i, ngÃ¢n sÃ¡ch, loáº¡i hÃ¬nh nÆ¡i á»Ÿ mong muá»‘n...), cÃ³ thá»ƒ há»i trá»±c tiáº¿p ngÆ°á»i dÃ¹ng.\n"
                "- Náº¿u ngÆ°á»i dÃ¹ng há»i vá» thá»© ngoÃ i chuyÃªn mÃ´n (vd: vÃ© mÃ¡y bay, tour trá»n gÃ³i...). HÃ£y dÃ¹ng 'CompleteOrEscalate' tool Ä‘á»ƒ Ä‘Æ°a cuá»™c Ä‘á»‘i thoáº¡i vá» láº¡i Primary Agent.\n"
                "- Náº¿u khÃ´ng cÃ³ tool nÃ o phÃ¹ há»£p Ä‘á»ƒ thá»±c hiá»‡n yÃªu cáº§u tá»« ngÆ°á»i dÃ¹ng, HÃ£y dÃ¹ng 'CompleteOrEscalate' tool Ä‘á»ƒ Ä‘Æ°a cuá»™c Ä‘á»‘i thoáº¡i vá» láº¡i Primary Agent.\n\n"

                "ğŸ’¡ **HÆ°á»›ng dáº«n quan trá»ng vá» viá»‡c dÃ¹ng 'CompleteOrEscalate':**\n"
                "- Pháº£i nÃ³i rÃµ lÃ  yÃªu cáº§u hay cÃ¢u há»i Ä‘Ã£ Ä‘Æ°á»£c giáº£i quyáº¿t chÆ°a (Complete key).\n"
                "- Pháº£i nÃ³i rÃµ nguyÃªn nhÃ¢n láº¡i chuyá»ƒn há»™i thoáº¡i cho Primary Agent (Reason key).\n\n"


                "ğŸ“Œ **ThÃ´ng tin nhÃ³m du lá»‹ch:**\n"
                f"{preferences_text}\n\n"

                "ğŸš€ HÃ£y giÃºp ngÆ°á»i dÃ¹ng cÃ³ cÃ¡c giao dá»‹ch tÃ i chÃ­nh an toÃ n vÃ  thuáº­n tiá»‡n!"
            ),
            ("placeholder", "{messages}"),

        ]
    )
    return agent_prompt

"""## Agent"""

Transaction_Agent_tools = [get_transaction_details, save_transaction_tool, CompleteOrEscalate]

def Transaction_Agent(state: State):
    prompt = create_transaction_prompt(state["preferences"])
    # print(prompt)
    runnable = prompt | llm.bind_tools(Transaction_Agent_tools)

    while True:
        result = runnable.invoke(state)

        if not result.tool_calls and (
            not result.content
            or isinstance(result.content, list)
            and not result.content[0].get("text")
        ):
            messages = state["messages"] + [("user", "Respond with a real output.")]
            state = {**state, "messages": messages}
        else:
            break

    state_out = {"messages": result}
    return state_out

"""# Compile the Graph"""

def is_new_user(state: State) -> bool:
    if len(state["messages"]) <= 1:
        return True

    if not state["dialog_state"]:
        return "Primary_Agent"
    return state["dialog_state"][-1]

def create_entry_node(agent_name: str) -> Callable:

    def entry_node(state: State) -> dict:
        tool_call_id = state["messages"][-1].tool_calls[0]["id"]
        return {
            "messages": [
                ToolMessage(
                  content=(
                      f"Trá»£ lÃ½ hiá»‡n táº¡i lÃ  {agent_name}. HÃ£y xem xÃ©t láº¡i cuá»™c trÃ² chuyá»‡n giá»¯a trá»£ lÃ½ chÃ­nh vÃ  ngÆ°á»i dÃ¹ng. "
                      "Ã Ä‘á»‹nh cá»§a ngÆ°á»i dÃ¹ng chÆ°a Ä‘Æ°á»£c Ä‘Ã¡p á»©ng. HÃ£y sá»­ dá»¥ng cÃ¡c cÃ´ng cá»¥ Ä‘Æ°á»£c cung cáº¥p Ä‘á»ƒ há»— trá»£ ngÆ°á»i dÃ¹ng. "
                      f"Nhá»› ráº±ng, báº¡n lÃ  {agent_name}, vÃ  viá»‡c Ä‘áº·t chá»—, cáº­p nháº­t hoáº·c báº¥t ká»³ hÃ nh Ä‘á»™ng nÃ o khÃ¡c sáº½ khÃ´ng hoÃ n táº¥t "
                      f"cho Ä‘áº¿n khi báº¡n Ä‘Ã£ gá»i thÃ nh cÃ´ng cÃ´ng cá»¥ phÃ¹ há»£p. "
                      "Náº¿u ngÆ°á»i dÃ¹ng thay Ä‘á»•i Ã½ Ä‘á»‹nh hoáº·c cáº§n trá»£ giÃºp cho cÃ¡c tÃ¡c vá»¥ khÃ¡c, hÃ£y dá»«ng cuá»™c trÃ² chuyá»‡n "
                      "Ä‘á»ƒ trá»£ lÃ½ chÃ­nh tiáº¿p quáº£n cuá»™c trÃ² chuyá»‡n. "
                      "KhÃ´ng Ä‘Æ°á»£c Ä‘á» cáº­p Ä‘áº¿n viá»‡c báº¡n lÃ  ai â€“ chá»‰ hÃ nh Ä‘á»™ng nhÆ° má»™t trá»£ lÃ½ thay máº·t cho há»‡ thá»‘ng."
                  ),
                  tool_call_id=tool_call_id,
              )
            ],
            "dialog_state": agent_name,
        }

    return entry_node

def handle_tool_error(state) -> dict:
    error = state.get("error")
    tool_calls = state["messages"][-1].tool_calls
    return {
        "messages": [
            ToolMessage(
                content=f"Error: {repr(error)}\n please fix your mistakes.",
                tool_call_id=tc["id"],
            )
            for tc in tool_calls
        ]
    }

def create_tool_node_with_fallback(tools: list) -> dict:
    return ToolNode(tools).with_fallbacks(
        [RunnableLambda(handle_tool_error)], exception_key="error"
    )

def route_primary_agent(state: State):

    route = tools_condition(state)

    if route == END:
        return END

    tool_calls = state["messages"][-1].tool_calls

    if tool_calls:
        if tool_calls[0]["name"] == ToAccommodation_Agent.__name__:
            return "enter_Accommodation_Agent"

        elif tool_calls[0]["name"] == ToDestination_Agent.__name__:
            return "enter_Destination_Agent"

        elif tool_calls[0]["name"] == ToFood_Agent.__name__:
            return "enter_Food_Agent"

        elif tool_calls[0]["name"] == ToTransaction_Agent.__name__:
            return "enter_Transaction_Agent"

        return "Primary_Agent_tools"

    raise ValueError("Invalid route")

def route_specific_agent(state: State):

    route = tools_condition(state)

    if route == END:
        return END

    tool_calls = state["messages"][-1].tool_calls
    did_cancel = any(tc["name"] == CompleteOrEscalate.__name__ for tc in tool_calls)

    if did_cancel:
        return "leave_agent"

    return route

# This node will be shared for exiting all specialized assistants
def pop_dialog_state(state: State) -> dict:
    """Pop the dialog stack and return to the main assistant.

    This lets the full graph explicitly track the dialog flow and delegate control
    to specific sub-graphs.
    """
    messages = []
    if state["messages"][-1].tool_calls:
        # Note: Doesn't currently handle the edge case where the llm performs parallel tool calls
        messages.append(
            ToolMessage(
                content="Resuming dialog with the Primary Agent. Please reflect on the past conversation and assist the user as needed.",
                tool_call_id=state["messages"][-1].tool_calls[0]["id"],
            )
        )
    else:
        messages.append(
            SystemMessage(
                content="Resuming dialog with the Primary Agent. Please reflect on the past conversation and assist the user as needed."
            )
        )
    return {
        "dialog_state": "pop",
        "messages": messages,
    }

builder = StateGraph(State)

builder.add_node("ask_preference", asking_preference)

builder.add_node("Primary_Agent", Primary_Agent)

builder.add_conditional_edges(
    START,
    is_new_user,
    {
      True: "ask_preference",
      "Primary_Agent": "Primary_Agent",
      "Accommodation_Agent": "Accommodation_Agent",
      "Destination_Agent": "Destination_Agent",
      "Food_Agent": "Food_Agent",
      "Transaction_Agent": "Transaction_Agent"
    }
  )
builder.add_edge("ask_preference", "Primary_Agent")

builder.add_node("Primary_Agent_tools", create_tool_node_with_fallback(Primary_Agent_tools))
builder.add_conditional_edges("Primary_Agent",
                              route_primary_agent,
                              [
                                  "enter_Transaction_Agent",
                                  "enter_Accommodation_Agent",
                                  "enter_Destination_Agent",
                                  "enter_Food_Agent",
                                  "Primary_Agent_tools",
                                  END,
                              ])
builder.add_edge("Primary_Agent_tools", "Primary_Agent")

builder.add_node("leave_agent", pop_dialog_state)
builder.add_edge("leave_agent", "Primary_Agent")

builder.add_node("enter_Accommodation_Agent", create_entry_node("Accommodation_Agent"))
builder.add_node("Accommodation_Agent", Accommodation_Agent)

builder.add_node("Accommodation_Agent_tools", create_tool_node_with_fallback(Accommodation_Agent_tools))
builder.add_edge("enter_Accommodation_Agent", "Accommodation_Agent")
builder.add_conditional_edges(
    "Accommodation_Agent",
    route_specific_agent,
    {"tools": "Accommodation_Agent_tools", "leave_agent" : "leave_agent", END: END},
)
builder.add_edge("Accommodation_Agent_tools", "Accommodation_Agent")

builder.add_node("enter_Destination_Agent", create_entry_node("Destination_Agent"))
builder.add_node("Destination_Agent", Destination_Agent)

builder.add_node("Destination_Agent_tools", create_tool_node_with_fallback(Destination_Agent_tools))
builder.add_edge("enter_Destination_Agent", "Destination_Agent")
builder.add_conditional_edges(
    "Destination_Agent",
    route_specific_agent,
    {"tools": "Destination_Agent_tools", "leave_agent" : "leave_agent", END: END},
)
builder.add_edge("Destination_Agent_tools", "Destination_Agent")

builder.add_node("enter_Food_Agent", create_entry_node("Food_Agent"))
builder.add_node("Food_Agent", Food_Agent)

builder.add_node("Food_Agent_tools", create_tool_node_with_fallback(Food_Agent_tools))
builder.add_edge("enter_Food_Agent", "Food_Agent")
builder.add_conditional_edges(
    "Food_Agent",
    route_specific_agent,
    {"tools": "Food_Agent_tools", "leave_agent" : "leave_agent", END: END},
)
builder.add_edge("Food_Agent_tools", "Food_Agent")

builder.add_node("enter_Transaction_Agent", create_entry_node("Transaction_Agent"))
builder.add_node("Transaction_Agent", Transaction_Agent)

builder.add_node("Transaction_Agent_tools", create_tool_node_with_fallback(Transaction_Agent_tools))
builder.add_edge("enter_Transaction_Agent", "Transaction_Agent")
builder.add_conditional_edges(
    "Transaction_Agent",
    route_specific_agent,
    {"tools": "Transaction_Agent_tools", "leave_agent": "leave_agent", END: END},
)
builder.add_edge("Transaction_Agent_tools", "Transaction_Agent")

# A checkpointer must be enabled for interrupts to work!
checkpointer = MemorySaver()
graph = builder.compile(checkpointer=checkpointer)

display(Image(graph.get_graph(xray=True).draw_mermaid_png()))

"""# FastAPI Server"""





"""# Communication"""

def _print_event(event: dict, _printed: set, max_length=1500):
    message = event.get("messages")
    if message:
        if isinstance(message, list):
            message = message[-1]

        if not isinstance(message, HumanMessage):
          if message.id not in _printed:
              msg_repr = message.pretty_repr(html=True)
              if len(msg_repr) > max_length:
                  msg_repr = msg_repr[:max_length] + " ... (truncated)"
              print(msg_repr)
              _printed.add(message.id)

    current_state = event.get("dialog_state")
    if current_state:
        print("Currently in: ", current_state[-1])

config = {
    "configurable": {
        "thread_id": uuid.uuid4(),
    }
}

_printed = set()
# We can reuse the tutorial questions from part 1 to see how it does.
while True:
    print("======================================user=======================================\n")
    user_input = input()
    events = graph.stream(
        {"messages": ("user", user_input)},
        config,
        stream_mode="values"
    )
    for event in events:
        _print_event(event, _printed)

# ''Báº¡n cÃ³ thá»ƒ giá»›i thiá»‡u má»™t sá»‘ nhá»¯ng Ä‘á»‹a Ä‘iá»ƒm du lá»‹ch ná»•i tiáº¿ng á»Ÿ ÄÃ  Láº¡t Ä‘Æ°á»£c khÃ´ng?''
# TÃ´i muá»‘n há»i vá» nhá»¯ng khÃ¡ch sáº¡n á»Ÿ ÄÃ  Láº¡t



snapshot = graph.get_state(config)

snapshot.values





